@model IEnumerable<MangaReader.Models.User>
@{
    ViewData["Title"] = "Manage Users";
    bool canManage = ViewBag.CanManage ?? false;
}

<div class="admin-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="text-white mb-0">
            <i class="fas fa-users me-2 text-primary"></i>User Directory
        </h4>
        @if (canManage)
        {
            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="fas fa-user-plus me-1"></i> Create User
            </button>
        }
    </div>

    <div class="card-body">
        <div class="search-section mb-4">
            <form method="get" class="row g-3">
                <div class="col-md-10">
                    <div class="input-group">
                        <span class="input-group-text admin-input border-end-0">
                            <i class="fas fa-search text-white-50"></i>
                        </span>
                        <input type="text" name="search" class="form-control admin-input border-start-0" placeholder="Search by username..." value="@ViewBag.Search">
                        @if (!string.IsNullOrEmpty(ViewBag.Search))
                        {
                            <a asp-action="ManageUsers" class="btn btn-outline-secondary admin-input border-start-0 d-flex align-items-center">
                                <i class="fas fa-times"></i>
                            </a>
                        }
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        Search
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table admin-table align-middle">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-placeholder me-3">
                                        @(string.IsNullOrEmpty(user.Username) ? "?" : user.Username[0].ToString().ToUpper())
                                    </div>
                                    <div>
                                        <div class="text-white fw-bold">@user.Username</div>
                                        <div class="text-white-50 smaller">ID: @user.Id</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                @if (user.IsAdmin)
                                {
                                    <span class="badge bg-danger smaller uppercase">Admin</span>
                                }
                                else if (user.IsSubAdmin)
                                {
                                    <span class="badge bg-warning text-dark smaller uppercase">Sub-Admin</span>
                                }
                                else
                                {
                                    <span class="badge bg-info text-dark smaller uppercase">User</span>
                                }
                            </td>
                            <td>
                                @if (user.IsActive)
                                {
                                    <span class="badge bg-success-subtle text-success border border-success border-opacity-25 smaller uppercase">
                                        <i class="fas fa-circle fs-xs me-1"></i>Active
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary-subtle text-white-50 border border-secondary border-opacity-25 smaller uppercase">
                                        <i class="fas fa-circle fs-xs me-1"></i>Inactive
                                    </span>
                                }
                            </td>
                            <td class="text-white-50 small">@user.CreatedAt.ToString("MMM dd, yyyy")</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-1">
                                    @if (canManage)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="openAwardModal(@user.Id, '@user.Username')" 
                                                title="Award Items">
                                            <i class="fas fa-trophy"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                onclick="openResetPasswordModal(@user.Id, '@user.Username')" 
                                                title="Reset Password">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="openEditRoleModal(@user.Id, '@user.Username', @user.IsAdmin.ToString().ToLower(), @user.IsSubAdmin.ToString().ToLower())"
                                                title="Edit Roles">
                                            <i class="fas fa-user-tag"></i>
                                        </button>
                                        <form asp-action="ToggleActive" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="userId" value="@user.Id" />
                                            <button type="submit" class="btn btn-sm @(user.IsActive ? "btn-outline-danger" : "btn-outline-success")" 
                                                    title="@(user.IsActive ? "Deactivate" : "Activate")">
                                                <i class="fas @(user.IsActive ? "fa-user-slash" : "fa-user-check")"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-white-50">
                                <i class="fas fa-users fa-3x mb-3 opacity-25"></i>
                                <p class="mb-0">No users found matching your search.</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .admin-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 2rem;
        overflow: hidden;
    }
    .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: rgba(0,0,0,0.2);
    }
    .card-body {
        padding: 1.5rem;
    }
    .admin-table {
        margin-bottom: 0;
    }
    .admin-table thead th {
        background: rgba(0,0,0,0.3);
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .admin-table tbody td {
        padding: 1rem 1.5rem;
        color: var(--text-primary);
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .admin-table tbody tr:hover td {
        background: rgba(255,255,255,0.02);
    }
    .avatar-placeholder {
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .admin-input {
        background: var(--bg-tertiary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    .admin-input:focus {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25) !important;
    }
    .smaller {
        font-size: 0.7rem;
    }
    .uppercase {
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .fs-xs {
        font-size: 0.5rem;
    }
</style>


<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <form asp-action="CreateUser" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-white">Create New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-white-50 small uppercase fw-bold">Username</label>
                        <input type="text" name="username" class="form-control admin-input" required placeholder="Enter username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50 small uppercase fw-bold">Initial Password</label>
                        <input type="password" name="password" class="form-control admin-input" required placeholder="Enter password">
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="form-check form-switch mb-3">
                                <input type="checkbox" name="isAdmin" value="true" class="form-check-input" id="isAdminCheck">
                                <label class="form-check-label text-white" for="isAdminCheck">Is Admin</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check form-switch mb-3">
                                <input type="checkbox" name="isSubAdmin" value="true" class="form-check-input" id="isSubAdminCheck">
                                <label class="form-check-label text-white" for="isSubAdminCheck">Is Sub-Admin</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <form asp-action="ResetUserPassword" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="userId" id="resetUserId" />
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-white">Reset Password: <span id="resetUsernameDisplay" class="text-primary"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-white-50 small uppercase fw-bold">New Password</label>
                        <input type="password" name="newPassword" class="form-control admin-input" required minlength="6" placeholder="Enter new password">
                        <div class="form-text text-white-50 smaller">Minimum 6 characters.</div>
                    </div>
                    <div class="alert alert-warning border-warning bg-warning bg-opacity-10 py-2">
                        <div class="d-flex">
                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                            <div class="small">This will immediately change the user's password.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Reset Password</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="editRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <form asp-action="UpdateRole" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="userId" id="roleUserId" />
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-white">Edit Roles: <span id="roleUsernameDisplay" class="text-primary"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check form-switch mb-3">
                        <input type="checkbox" name="isAdmin" value="true" class="form-check-input" id="editIsAdmin">
                        <label class="form-check-label text-white" for="editIsAdmin">Admin Privileges</label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input type="checkbox" name="isSubAdmin" value="true" class="form-check-input" id="editIsSubAdmin">
                        <label class="form-check-label text-white" for="editIsSubAdmin">Sub-Admin Privileges</label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Roles</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="awardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Award Items: <span id="awardUsernameDisplay" class="text-primary"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="nav nav-tabs admin-tabs border-secondary" id="awardTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="titles-tab" data-bs-toggle="tab" data-bs-target="#titles" type="button">Titles</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="decorations-tab" data-bs-toggle="tab" data-bs-target="#decorations" type="button">Decorations</button>
                    </li>
                </ul>
                <div class="tab-content p-4" id="awardTabsContent">
                    <div class="tab-pane fade show active" id="titles">
                        <form asp-action="AwardTitle" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="userId" id="awardTitleUserId" />
                            <div class="mb-4">
                                <label class="form-label text-white-50 small uppercase fw-bold">Select Title</label>
                                <select name="titleId" class="form-select admin-input">
                                    @foreach (var title in (IEnumerable<MangaReader.Models.UserTitle>)ViewBag.AvailableTitles)
                                    {
                                        <option value="@title.Id">@title.Name (Lv. @title.LevelRequirement)</option>
                                    }
                                </select>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Award Title</button>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="decorations">
                        <form asp-action="AwardDecoration" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="userId" id="awardDecUserId" />
                            <div class="mb-4">
                                <label class="form-label text-white-50 small uppercase fw-bold">Select Decoration</label>
                                <select name="decorationId" class="form-select admin-input">
                                    @foreach (var dec in (IEnumerable<MangaReader.Models.PfpDecoration>)ViewBag.AvailableDecorations)
                                    {
                                        <option value="@dec.Id">@dec.Name (Lv. @dec.LevelRequirement)</option>
                                    }
                                </select>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-info text-white">Award Decoration</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openAwardModal(id, username) {
            document.getElementById('awardTitleUserId').value = id;
            document.getElementById('awardDecUserId').value = id;
            document.getElementById('awardUsernameDisplay').innerText = username;
            new bootstrap.Modal(document.getElementById('awardModal')).show();
        }

        function openResetPasswordModal(id, username) {
            document.getElementById('resetUserId').value = id;
            document.getElementById('resetUsernameDisplay').innerText = username;
            new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
        }

        function openEditRoleModal(id, username, isAdmin, isSubAdmin) {
            document.getElementById('roleUserId').value = id;
            document.getElementById('roleUsernameDisplay').innerText = username;
            document.getElementById('editIsAdmin').checked = isAdmin;
            document.getElementById('editIsSubAdmin').checked = isSubAdmin;
            new bootstrap.Modal(document.getElementById('editRoleModal')).show();
        }
    </script>
}

<style>
    .admin-tabs .nav-link {
        color: var(--text-muted);
        border: none;
        border-bottom: 2px solid transparent;
        padding: 1rem 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        transition: all 0.2s;
    }
    .admin-tabs .nav-link:hover {
        color: var(--text-primary);
        background: rgba(255,255,255,0.05);
    }
    .admin-tabs .nav-link.active {
        color: var(--primary-color);
        background: transparent;
        border-bottom-color: var(--primary-color);
    }
</style>
